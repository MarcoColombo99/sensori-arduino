<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>Dati Sensori 1111</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <h1>Grafici dei sensori</h1>

  <h2>Seleziona periodo</h2>
  <label>Inizio:</label>
  <input type="datetime-local" id="startDateTime">
  <label>Fine:</label>
  <input type="datetime-local" id="endDateTime">
  <button onclick="caricaDatiStorici()">ðŸ“ˆ Carica dati storici</button>

  <h3>Media A0: <span id="avgA0">--</span></h3>
  <canvas id="chartA0"></canvas>

  <h3>Media A1: <span id="avgA1">--</span></h3>
  <canvas id="chartA1"></canvas>

  <h3>Media A2: <span id="avgA2">--</span></h3>
  <canvas id="chartA2"></canvas>

  <script>
    const labels = [];
    const dataA0 = [], dataA1 = [], dataA2 = [];

    const config = (label, data, color) => ({
      type: "line",
      data: {
        labels: labels,
        datasets: [{
          label: label,
          data: data,
          borderColor: color,
          fill: false
        }]
      },
      options: {
        responsive: true,
        scales: {
          x: { display: true },
          y: { display: true }
        }
      }
    });

    const chartA0 = new Chart(document.getElementById("chartA0"), config("A0", dataA0, "red"));
    const chartA1 = new Chart(document.getElementById("chartA1"), config("A1", dataA1, "green"));
    const chartA2 = new Chart(document.getElementById("chartA2"), config("A2", dataA2, "blue"));

    function updateAverage(chart, data) {
      const avg = data.length ? (data.reduce((a, b) => a + b, 0) / data.length).toFixed(2) : "--";
      const id = "avg" + chart.config.data.datasets[0].label;
      document.getElementById(id).textContent = avg;
    }

    function caricaDatiStorici() {
      const startDateTime = document.getElementById("startDateTime").value;
      const endDateTime = document.getElementById("endDateTime").value;

      if (!startDateTime || !endDateTime) {
        alert("Inserisci sia data e ora di inizio che di fine");
        return;
      }

      const url = `http://arduino.local/read_from_sd?start=${encodeURIComponent(startDateTime)}&end=${encodeURIComponent(endDateTime)}`;

      fetch(url)
        .then(response => {
          if (!response.ok) throw new Error("Errore nella risposta dal server");
          return response.text();
        })
        .then(csv => {
          const righe = csv.trim().split("\n").slice(2); // ignora intestazioni
          const newLabels = [], newA0 = [], newA1 = [], newA2 = [];

          for (const riga of righe) {
            const campi = riga.split(";");
            const dataOra = `${campi[1]} ${campi[0]}`;
            newLabels.push(dataOra);
            newA0.push(parseFloat(campi[2]));
            newA1.push(parseFloat(campi[3]));
            newA2.push(parseFloat(campi[4]));
          }

          // aggiorna i dati dei grafici
          labels.length = 0;
          dataA0.length = 0;
          dataA1.length = 0;
          dataA2.length = 0;

          labels.push(...newLabels);
          dataA0.push(...newA0);
          dataA1.push(...newA1);
          dataA2.push(...newA2);

          chartA0.update();
          chartA1.update();
          chartA2.update();

          updateAverage(chartA0, dataA0);
          updateAverage(chartA1, dataA1);
          updateAverage(chartA2, dataA2);
        })
        .catch(error => {
          console.error("Errore caricamento dati storici:", error);
          alert("Errore caricamento dati storici: " + error.message);
        });
    }
  </script>
</body>
</html>
